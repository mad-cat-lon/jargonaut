# unicloak ![pep-8](https://github.com/xor-eax-eax-ret/unicloak/actions/workflows/pep8.yml/badge.svg)
`unicloak` is an obfuscator for hiding and protecting Python code with a few novel features. Note that this is a work in progress! 

## Features
- Basic variable, function and parameter renaming (more coming soon)
- Very basic string obfuscation 
- String matching evasion with [Unicode identifier variants](https://blog.phylum.io/malicious-actors-use-unicode-support-in-python-to-evade-detection)
- [Linear mixed boolean arithmetic expressions](https://link.springer.com/chapter/10.1007/978-3-540-77535-5_5)

## Upcoming features 
- Logging / debugging 
- Obfuscate based on user-defined rules 
- Better string obfuscation methods
- Dead code insertion
- Variable obfuscation methods (e.g `useful_var_name` -> `1l1l1l1lll`)
- Comment removal 
- Dead parameter insertion
- Type hint removal 
- C function conversion a la [pyarmor](https://github.com/dashingsoft/pyarmor)
- Documentation
- Better performance (maybe don't use z3 for MBA)

## Usage
```main.py source.py obfuscated.py```

## Examples
### Unicode identifier variants
#### Original
```
import math
import requests
from win32crypt import CryptUnprotectData

if __name__ == "__main__":
    external_ip = requests.get('http://whatismyip.akamai.com/').text
    CryptUnprotectData(b"foobar")
    print(external_ip)
```
#### Obfuscated 
```
import â‚˜â‚ğ–™ğ—
import ï½’ğ–Šğššğ’–ğšÅ¿ğ˜Ë¢
from ğ™¬áµ¢ğ”«ï¼“ğŸï½ƒğ“»ğ—’ğ”­ğ‘¡ import ğ•®ğ“‡ğ˜†ğ–•ğ”±ğ’°ğ—»ğ’‘ğ‘Ÿğ—¼ğ“‰ğ—²â…½ğ–™â…®ğ™–ğ‘¡áµƒ
if __name__ == '__main__':
    ğ˜¦ğ”ğ‘¡â‚‘áµ£ğ–“ğšŠğ–‘ï¼¿ğ—‚ï½ = ğ“‡â„¯ğššáµ¤â„¯ğ¬ğ˜s.get('http://whatismyip.akamai.com/').text
    ï¼£ğ—‹yğ’‘ğ’•ğ•Œâ‚™ğ˜±ğ˜³ğ‘œğ”±â…‡ğ–¼ğ™©ğ’Ÿğ’¶ğ™©ğ™–(b'foobar')
    print(ğ–¾ğš¡áµ—ğğ—¿ğš—aâ„“ï¸´ğ“²ğ˜±)
```
### MBA obfuscation
#### Original 
```
def op(x):
    a = 1
    b = 2
    c = a + b
    d = x - c 
    return d + 10

if __name__ == "__main__":
    a = op(10)
    print(a)
```
#### Obfuscated 
```
def op(x):
    a = -1 * (1337 & ~1984) + 1 * 1337 + 1 * (1337 ^ 1984) + -1 * (1337 | 1984) + -1 * -1
    b = -1 * (1337 & 1984) + -1 * (1337 & ~1984) + -1 * (~1337 & 1984) + 1 * (1337 ^ 1984) + -1 * ~(1337 | 1984) + 1 * ~(1337 ^ 1984) + -2 * -1
    c = -(-1 * (1337 & 1984) + -1 * (1337 & ~1984) + -1 * 1984 + 1 * (1337 | 1984) + -1 * ~(1337 | 1984) + 1 * ~(1337 ^ 1984) + -5 * -1) * (a & b) + (-1 * (~1337 & 1984) + -2 * 1984 + 5 * (1337 ^ 1984) + -2 * (1337 | 1984) + -1 * ~(1337 | 1984) + 4 * ~(1337 ^ 1984) + -3 * ~1984 + -1 * -1) * a + -(1 * (1337 & 1984) + -2 * (1337 & ~1984) + -1 * (~1337 & 1984) + 2 * 1984 + -1 * (1337 ^ 1984) + -3 * ~(1337 ^ 1984) + 3 * ~1984 + -1 * -1) * b + -(1 * 1984 + -1 * (1337 | 1984) + -1 * ~(1337 | 1984) + 1 * ~1984 + -1 * -1) * (a ^ b) + (2 * (1337 & 1984) + 1 * (~1337 & 1984) + -1 * 1984 + 1 * (1337 ^ 1984) + -1 * (1337 | 1984) + -3 * -1) * (a | b) + -(1 * (1337 & 1984) + -2 * 1337 + -3 * 1984 + 3 * (1337 | 1984) + 1 * ~(1337 ^ 1984) + -1 * ~1984 + -2 * -1) * ~(a | b) + (5 * (1337 & ~1984) + -3 * 1337 + -1 * ~(1337 | 1984) + 3 * ~(1337 ^ 1984) + -2 * ~1984 + -4 * -1) * ~(a ^ b) + -(2 * (1337 & 1984) + 2 * (~1337 & 1984) + -2 * 1984 + -2 * -1) * ~b
    d = (2 * (1337 & 1984) + 2 * (1337 & ~1984) + 2 * (~1337 & 1984) + -1 * 1984 + -1 * (1337 | 1984) + 1 * ~(1337 | 1984) + -1 * ~1984 + -3 * -1) * x + (2 * (1337 & 1984) + 2 * 1337 + 2 * (~1337 & 1984) + -2 * (1337 | 1984) + 2 * ~(1337 | 1984) + -2 * ~(1337 ^ 1984) + -3 * -1) * (~x & c) + -(-2 * (1337 & ~1984) + -4 * (~1337 & 1984) + 8 * (1337 ^ 1984) + -4 * (1337 | 1984) + -2 * ~(1337 | 1984) + 4 * ~(1337 ^ 1984) + -2 * ~1984 + -3 * -1) * c + -(3 * (1337 & 1984) + -4 * (1337 & ~1984) + -1 * (~1337 & 1984) + -1 * 1984 + 2 * (1337 ^ 1984) + -2 * ~(1337 ^ 1984) + 2 * ~1984 + -1 * -1) * (x ^ c) + (-1 * (1337 & 1984) + -2 * (1337 & ~1984) + 2 * 1337 + 2 * (~1337 & 1984) + -1 * 1984 + -1 * (1337 ^ 1984) + -1 * ~(1337 | 1984) + 1 * ~1984 + -1 * -1) * ~(x | c) + -(-2 * (1337 & 1984) + -1 * 1337 + -4 * (~1337 & 1984) + 5 * 1984 + -1 * (1337 | 1984) + -1 * ~(1337 | 1984) + -1 * ~(1337 ^ 1984) + 2 * ~1984 + -1 * -1) * ~c
    return d + (-4 * (1337 & 1984) + 1 * 1337 + -1 * (~1337 & 1984) + 1 * 1984 + -1 * ~(1337 | 1984) + 2 * ~(1337 ^ 1984) + -1 * ~1984 + -10 * -1)
if __name__ == '__main__':
    a = op(1 * (1337 & 1984) + 1 * (1337 ^ 1984) + -1 * (1337 | 1984) + -10 * -1)
    print(a)
```
### Variable renaming 
#### Original
```

def fib(n):
    nterms = n 
    n1, n2 = 0, 1
    count = 0

    if nterms <= 0:
        print("Please enter a positive integer")
    elif nterms == 1:
        print("Fibonacci sequence upto",nterms,":")
        print(n1)
    else:
        print("Fibonacci sequence:")
    while count < nterms:
        print(n1)
        nth = n1 + n2
        n1 = n2
        n2 = nth
        count += 1
    return count

if __name__ == "__main__":
    print(fib(2))
    n = 1
    print(n+1)
```
#### Obfuscated with variable renaming, MBA expressions and Unicode variants
```
# -*- coding: utf-8 -*
def á¸»llá¼°IIá¸»Iá¼°á¼°á¸»l(IIá¼°Iá¼°llá¸»Iá¸»Iá¸»):
    lá¼°á¸»lllá¸»á¸»lIá¼°l = IIá¼°Iá¼°llá¸»Iá¸»Iá¸»
    (á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼°, á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI) = (-2 * (1337 & 31415) + -1 * 1337 + -3 * 31415 + 3 * (1337 | 31415) + -1 * ~(1337 | 31415) + 3 * ~(1337 ^ 31415) + -2 * ~31415, -3 * (747 & ~999) + -1 * (~747 & 999) + 1 * (747 ^ 999) + -2 * ~(747 | 999) + 2 * ~999 + -1 * -1)
    IIIá¼°llIá¸»Iá¸»ll = -2 * (31415 & 999) + -2 * (31415 & ~999) + -1 * (~31415 & 999) + -1 * 999 + 2 * (31415 | 999) + -1 * ~(31415 | 999) + 1 * ~(31415 ^ 999)
    if lá¼°á¸»lllá¸»á¸»lIá¼°l <= -1 * (999 & 31415) + 3 * 31415 + -2 * (999 ^ 31415) + -1 * (999 | 31415) + -2 * ~(999 | 31415) + -1 * ~(999 ^ 31415) + 3 * ~31415:
        ğ–•ğ™§ğ–ğ”«ğ­((lambda MBbeo, WhUrA='utf-8', UzEAc='surrogatepass': (BbtMq := int(MBbeo, 2)).to_bytes((BbtMq.bit_length() + 7) // 8, 'big').decode(WhUrA, UzEAc) or '')(''.join(['0' if RhjLW == 'ğ™“' else '1' for RhjLW in 'ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“ğ‘¿ğ™“ğ‘¿ğ‘¿ğ‘¿ğ™“ğ™“ğ‘¿ğ™“'])))
    elif lá¼°á¸»lllá¸»á¸»lIá¼°l == -2 * (1337 & 999) + -2 * (1337 & ~999) + -1 * (~1337 & 999) + -1 * 999 + -1 * (1337 ^ 999) + 3 * (1337 | 999) + -1 * -1:
        ğ•¡ğ–—ğ”¦ğ—‡áµ—((lambda YgMbH, BCifc='utf-8', VLZLn='surrogatepass': (JskjK := int(YgMbH, 2)).to_bytes((JskjK.bit_length() + 7) // 8, 'big').decode(BCifc, VLZLn) or '')(''.join(['0' if iqeFl == 'ê³' else '1' for iqeFl in 'ê³ğš‡ê³ê³ê³ğš‡ğš‡ê³ê³ğš‡ğš‡ê³ğš‡ê³ê³ğš‡ê³ğš‡ğš‡ê³ê³ê³ğš‡ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ğš‡ğš‡ê³ğš‡ğš‡ê³ğš‡ğš‡ğš‡ê³ê³ğš‡ğš‡ê³ê³ê³ê³ğš‡ê³ğš‡ğš‡ê³ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ê³ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ê³ğš‡ê³ê³ğš‡ê³ê³ğš‡ê³ê³ê³ê³ê³ê³ğš‡ğš‡ğš‡ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ê³ê³ğš‡ê³ğš‡ê³ğš‡ğš‡ğš‡ê³ê³ê³ğš‡ê³ğš‡ğš‡ğš‡ê³ğš‡ê³ğš‡ê³ğš‡ğš‡ê³ê³ğš‡ê³ğš‡ê³ğš‡ğš‡ê³ğš‡ğš‡ğš‡ê³ê³ğš‡ğš‡ê³ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ê³ê³ğš‡ê³ğš‡ê³ê³ğš‡ê³ê³ê³ê³ê³ê³ğš‡ğš‡ğš‡ê³ğš‡ê³ğš‡ê³ğš‡ğš‡ğš‡ê³ê³ê³ê³ê³ğš‡ğš‡ğš‡ê³ğš‡ê³ê³ê³ğš‡ğš‡ê³ğš‡ğš‡ğš‡ğš‡'])), lá¼°á¸»lllá¸»á¸»lIá¼°l, (lambda hGbEk, lpzfe='utf-8', CBUTk='surrogatepass': (iwxpe := int(hGbEk, 2)).to_bytes((iwxpe.bit_length() + 7) // 8, 'big').decode(lpzfe, CBUTk) or '')(''.join(['0' if JDZbe == 'ğ‘¿' else '1' for JDZbe in 'ğ‘¿ğ‘¿ğ™“ğ™“ğ™“ğ‘¿ğ™“ğ‘¿'])))
        ğš™ï½’â±ğ—»ğ˜µ(á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼°)
    else:
        ğ—‰ğ˜³ğ˜ªğ“·ğš((lambda HSnQC, FeGdK='utf-8', FOiDM='surrogatepass': (KsjHe := int(HSnQC, 2)).to_bytes((KsjHe.bit_length() + 7) // 8, 'big').decode(FeGdK, FOiDM) or '')(''.join(['0' if vXJNb == 'ê³' else '1' for vXJNb in 'ê³ğ™“ê³ê³ê³ğ™“ğ™“ê³ê³ğ™“ğ™“ê³ğ™“ê³ê³ğ™“ê³ğ™“ğ™“ê³ê³ê³ğ™“ê³ê³ğ™“ğ™“ê³ğ™“ğ™“ğ™“ğ™“ê³ğ™“ğ™“ê³ğ™“ğ™“ğ™“ê³ê³ğ™“ğ™“ê³ê³ê³ê³ğ™“ê³ğ™“ğ™“ê³ê³ê³ğ™“ğ™“ê³ğ™“ğ™“ê³ê³ê³ğ™“ğ™“ê³ğ™“ğ™“ê³ğ™“ê³ê³ğ™“ê³ê³ğ™“ê³ê³ê³ê³ê³ê³ğ™“ğ™“ğ™“ê³ê³ğ™“ğ™“ê³ğ™“ğ™“ê³ê³ğ™“ê³ğ™“ê³ğ™“ğ™“ğ™“ê³ê³ê³ğ™“ê³ğ™“ğ™“ğ™“ê³ğ™“ê³ğ™“ê³ğ™“ğ™“ê³ê³ğ™“ê³ğ™“ê³ğ™“ğ™“ê³ğ™“ğ™“ğ™“ê³ê³ğ™“ğ™“ê³ê³ê³ğ™“ğ™“ê³ğ™“ğ™“ê³ê³ğ™“ê³ğ™“ê³ê³ğ™“ğ™“ğ™“ê³ğ™“ê³'])))
    while IIIá¼°llIá¸»Iá¸»ll < lá¼°á¸»lllá¸»á¸»lIá¼°l:
        ï½Ê³iğ˜¯ğ—(á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼°)
        á¼°Illá¸»á¼°Iá¼°Ilá¸»á¼° = -(2 * (31415 & 1984) + 5 * 1984 + -5 * (31415 | 1984) + -3 * ~(31415 | 1984) + -2 * ~(31415 ^ 1984) + 5 * ~1984 + -1 * -1) * (á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° & ~á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI) + (-1 * (999 & 420) + -1 * (999 & ~420) + -1 * (~999 & 420) + -1 * (999 ^ 420) + 2 * (999 | 420) + 1 * ~(999 | 420) + -1 * ~(999 ^ 420) + -1 * -1) * á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° + -(-1 * (999 & 420) + 1 * (999 & ~420) + -1 * (~999 & 420) + 2 * 420 + -1 * (999 | 420) + -2 * -1) * (~á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° & á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI) + (-1 * (999 & ~420) + -2 * 999 + -5 * 420 + 5 * (999 | 420) + 2 * ~(999 ^ 420) + -2 * ~420 + -2 * -1) * á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI + (1 * (1337 & 1984) + 4 * (1337 & ~1984) + -3 * 1337 + -1 * (~1337 & 1984) + 2 * 1984 + -1 * (1337 | 1984) + -1 * ~(1337 | 1984) + 1 * ~(1337 ^ 1984) + -2 * -1) * (á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° ^ á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI) + -(-2 * (1984 & 1337) + -1 * (1984 & ~1337) + -1 * 1984 + -6 * (~1984 & 1337) + 7 * (1984 ^ 1337) + -1 * (1984 | 1337) + 4 * ~(1984 ^ 1337) + -4 * ~1337 + -1 * -1) * (á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° | á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI)
        á¸»á¼°á¼°lIlá¸»llá¼°á¼°á¼° = á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI
        á¸»á¸»á¸»lá¸»á¸»lá¼°lIlI = á¼°Illá¸»á¼°Iá¼°Ilá¸»á¼°
        IIIá¼°llIá¸»Iá¸»ll += -1 * (31415 & ~1984) + -1 * 31415 + -3 * (~31415 & 1984) + -1 * 1984 + 5 * (31415 ^ 1984) + -1 * (31415 | 1984) + -1 * ~(31415 | 1984) + 3 * ~(31415 ^ 1984) + -2 * ~1984 + -1 * -1
    return IIIá¼°llIá¸»Iá¸»ll
if _ï¸³ğ—‡ğ™–ğ—ºâ„¯ï¹ï¼¿ == (lambda jPgOQ, gnBjk='utf-8', aBtqN='surrogatepass': (NbiXd := int(jPgOQ, 2)).to_bytes((NbiXd.bit_length() + 7) // 8, 'big').decode(gnBjk, aBtqN) or '')(''.join(['0' if JMahR == 'ğ‘¿' else '1' for JMahR in 'ğ‘¿ê³ğ‘¿ê³ê³ê³ê³ê³ğ‘¿ê³ğ‘¿ê³ê³ê³ê³ê³ğ‘¿ê³ê³ğ‘¿ê³ê³ğ‘¿ê³ğ‘¿ê³ê³ğ‘¿ğ‘¿ğ‘¿ğ‘¿ê³ğ‘¿ê³ê³ğ‘¿ê³ğ‘¿ğ‘¿ê³ğ‘¿ê³ê³ğ‘¿ê³ê³ê³ğ‘¿ğ‘¿ê³ğ‘¿ê³ê³ê³ê³ê³ğ‘¿ê³ğ‘¿ê³ê³ê³ê³ê³'])):
    ğ©ğ—‹â±ğš—ğ“‰(á¸»llá¼°IIá¸»Iá¼°á¼°á¸»l(-3 * 1984 + -3 * (~1984 & 420) + 4 * (1984 ^ 420) + -1 * (1984 | 420) + -4 * ~(1984 | 420) + 4 * ~(1984 ^ 420) + -2 * -1))
    IIá¼°Iá¼°llá¸»Iá¸»Iá¸» = 1 * (1337 & 999) + -2 * (~1337 & 999) + 6 * (1337 ^ 999) + -4 * (1337 | 999) + -1 * ~(1337 | 999) + 3 * ~(1337 ^ 999) + -2 * ~999 + -1 * -1
    ğ—‰ğ—¿ğ—‚ğ™£ğ—(IIá¼°Iá¼°llá¸»Iá¸»Iá¸» + (-1 * (999 & 1337) + 2 * 999 + -1 * (~999 & 1337) + 2 * (999 ^ 1337) + -1 * (999 | 1337) + 3 * ~(999 | 1337) + -3 * ~1337 + -1 * -1))
```
## Requirements 
- z3-solver
- numpy

## References
- https://blog.phylum.io/malicious-actors-use-unicode-support-in-python-to-evade-detection
- https://peps.python.org/pep-0672/#normalizing-identifiers
- https://peps.python.org/pep-3131/
- https://unicode.org/reports/tr15/
- https://docs.python.org/3/library/ast.html
- https://link.springer.com/chapter/10.1007/978-3-540-77535-5_5
- https://theses.hal.science/tel-01623849/document
- https://bbs.kanxue.com/thread-271574.htm